services:
  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: researchcruiseapp-cloudbeaver
    environment:
      # Configure CloudBeaver to work behind reverse proxy
      # Tell it to trust the X-Forwarded-For header from Caddy
      - CB_SERVER_URL=https://cloudbeaver.wsiwiec.com
      - CB_PROXY_MODE=true
    volumes:
      - cloudbeaver-workspace:/opt/cloudbeaver/workspace
      # Pre-configured connections via data-sources.json
      - ./config:/opt/cloudbeaver/workspace/GlobalConfiguration/.dbeaver
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8978/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - researchcruiseapp-network
      - proxy
    expose:
      - 8978
    labels:
      caddy: cloudbeaver.wsiwiec.com
      caddy.route.import: crowdsec_auth
      caddy.route.reverse_proxy: "{{upstreams 8978}}"
      # Ensure proper header forwarding for reverse proxy
      caddy.route.reverse_proxy.header_up: "X-Real-IP {client_ip}"
      caddy.route.reverse_proxy.header_up_1: "X-Forwarded-For {client_ip}"
      caddy.route.reverse_proxy.header_up_2: "X-Forwarded-Proto {scheme}"
      caddy.route.reverse_proxy.header_up_3: "X-Forwarded-Host {host}"

volumes:
  cloudbeaver-workspace:

networks:
  researchcruiseapp-network:
    external: true
  proxy:
    external: true
