services:
  cloudbeaver-init:
    image: busybox:latest
    container_name: researchcruiseapp-cloudbeaver-init
    command: >
      sh -c "mkdir -p /workspace/GlobalConfiguration/.dbeaver && 
             echo 'CloudBeaver workspace initialized' && 
             sleep 2"
    volumes:
      - cloudbeaver-workspace:/workspace
    networks:
      - researchcruiseapp-network

  cloudbeaver:
    image: dbeaver/cloudbeaver:latest
    container_name: researchcruiseapp-cloudbeaver
    depends_on:
      cloudbeaver-init:
        condition: service_completed_successfully
    environment:
      # Configure CloudBeaver to work behind reverse proxy
      # Tell it to trust the X-Forwarded-For header from Caddy
      - CB_SERVER_URL=https://cloudbeaver.wsiwiec.com
      - CB_PROXY_MODE=true
      # Allow requests from Authelia domain
      - CB_ALLOWED_HOSTS=cloudbeaver.wsiwiec.com,auth.wsiwiec.com
    volumes:
      - cloudbeaver-workspace:/opt/cloudbeaver/workspace
      # Pre-configured connections via data-sources.json
      - ./config/data-sources.json:/opt/cloudbeaver/workspace/GlobalConfiguration/.dbeaver/data-sources.json:ro
    networks:
      - researchcruiseapp-network
      - proxy
    expose:
      - 8978
    labels:
      caddy: cloudbeaver.wsiwiec.com
      caddy.route.import: crowdsec_auth
      caddy.route.reverse_proxy: "{{upstreams 8978}}"
      # Ensure proper header forwarding for reverse proxy
      caddy.route.reverse_proxy.header_up: "X-Real-IP {client_ip}"
      caddy.route.reverse_proxy.header_up_1: "X-Forwarded-For {client_ip}"
      caddy.route.reverse_proxy.header_up_2: "X-Forwarded-Proto {scheme}"
      caddy.route.reverse_proxy.header_up_3: "X-Forwarded-Host {host}"

volumes:
  cloudbeaver-workspace:

networks:
  researchcruiseapp-network:
    external: true
  proxy:
    external: true
