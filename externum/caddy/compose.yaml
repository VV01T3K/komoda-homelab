services:
  caddy:
    container_name: caddy
    build: .
    restart: unless-stopped
    env_file:
      - .env
    environment:
      CADDY_INGRESS_NETWORKS: proxy
      CADDY_DOCKER_POLLING_INTERVAL: 5s
      ACME_AGREE: true
      CROWDSEC_API_KEY: ${CROWDSEC_API_KEY}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # - ./caddy/data:/data/caddy      #ðŸ‘ˆ where to save SSL certs
      # - ./caddy/config:/config/caddy  #ðŸ‘ˆ where to save configs
      - ./caddy/snippets:/snip:ro     #ðŸ‘ˆ custom snippets
      - caddy_data:/data/caddy
      - caddy_config:/config/caddy
    networks:
      - proxy
      - crowdsec
    security_opt:
      - no-new-privileges=true
    ports:
      - 80:80
      - 443:443
      - 443:443/udp
    extra_hosts:
      - host.docker.internal:host-gateway
  caddy-config:
    container_name: caddy-config
    image: traefik/whoami:latest
    env_file:
      - .env
    networks:
      - proxy
      - crowdsec
    restart: unless-stopped
    labels:
      #############################################
      # Settings and snippets to get things working
      # You shouldn't need to modify this normally
      # Custom settings and definitions are below
      #############################################

      #### Global Settings ####
      caddy_0.email: "{env.EMAIL}"
      caddy_0.auto_https: prefer_wildcard
      #### Storage Settings ####
      caddy_0.storage: redis
      caddy_0.storage.address: "{env.VALKEY_HOST}:{env.VALKEY_PORT}"
      caddy_0.storage.password: "{env.VALKEY_PASSWORD}"
      caddy_0.storage.db: 0
      caddy_0.storage.timeout: 5
      caddy_0.storage.key_prefix: caddy
      caddy_0.storage.encryption_key: "{env.VALKEY_ENCRYPTION_KEY}"
      caddy_0.storage.compression: true
      caddy_0.order: "crowdsec before forward_auth"
      caddy_0.order_1: "crowdsec before reverse_proxy"
      caddy_0.crowdsec: ""
      caddy_0.crowdsec.api_url: "http://crowdsec:8080"
      caddy_0.crowdsec.api_key: "{env.CROWDSEC_API_KEY}"
      #### Snippets ####
      # Get wildcard certificate
      caddy_1: (wildcard)
      caddy_1.tls.dns: cloudflare {env.CF_API_TOKEN}
      caddy_1.tls.ca: "${ACME_CA_ENDPOINT:-https://acme-staging-v02.api.letsencrypt.org/directory}" # ðŸ‘ˆ Defaults to staging
      caddy_1.tls.resolvers: 1.1.1.1 1.0.0.1
      caddy_1.handle.abort: ""
      # Secure a site with Authelia
      caddy_2: (auth)
      caddy_2.forward_auth: "https://{env.AUTH_HOST}"
      caddy_2.forward_auth.uri: /api/authz/forward-auth
      caddy_2.forward_auth.copy_headers: Remote-User Remote-Groups Remote-Name Remote-Email
      # Skip TLS verify for backend with self-signed HTTPS
      caddy_3: (https)
      caddy_3.transport: http
      caddy_3.transport.tls: ""
      caddy_3.transport.tls_insecure_skip_verify: ""
      # CrowdSec protection
      caddy_4: (crowdsec)
      caddy_4.crowdsec: ""
      # CrowdSec + Authelia protection (ordered)
      caddy_5: (crowdsec_auth)
      caddy_5.route: ""
      caddy_5.route.0_crowdsec: "" #ðŸ‘ˆ CrowdSec blocks FIRST
      caddy_5.route.1_forward_auth: "https://{env.AUTH_HOST}" #ðŸ‘ˆ Auth runs SECOND
      caddy_5.route.1_forward_auth.uri: /api/authz/forward-auth
      caddy_5.route.1_forward_auth.copy_headers: Remote-User Remote-Groups Remote-Name Remote-Email
      ###########################################
      # Custom settings. Modify things below ðŸ‘‡:
      # Make sure they have unique label numbers
      ###########################################

      # Custom global settings, add/edit as needed
      # caddy_0.log: default
      # caddy_0.log.format: console

      # Uncomment this during testing to avoid hitting rate limit.
      # It will try to obtain SSL from Let's Encrypt's staging endpoint.

      ## Setup wildcard sites
      caddy_9: "*.wsiwiec.com" #ðŸ‘ˆ Change to your domain
      caddy_9.import: wildcard
      caddy_10: "*.lab.wsiwiec.com" #ðŸ‘ˆ Change to your domain
      caddy_10.import: wildcard
      # Add our first site, which this container itself
      caddy_99: whoami_externum_crowdauth.wsiwiec.com #ðŸ‘ˆ Subdomain using wildcard cert
      caddy_99.route.import: crowdsec_auth #ðŸ‘ˆ Import snippet with correct order
      caddy_99.route.reverse_proxy: "{{upstreams 80}}" #ðŸ‘ˆ Container port
      
      caddy_100: whoami_externum_auth.wsiwiec.com #ðŸ‘ˆ Subdomain using wildcard cert
      caddy_100.import: auth #ðŸ‘ˆ Import snippet with correct order
      caddy_100.reverse_proxy: "{{upstreams 80}}" #ðŸ‘ˆ Container port
      
      caddy_101: whoami_externum.wsiwiec.com #ðŸ‘ˆ Subdomain using wildcard cert
      caddy_101.reverse_proxy: "{{upstreams 80}}" #ðŸ‘ˆ Container port

volumes:
  caddy_data:
  caddy_config:

networks:
  proxy:
    external: true
  crowdsec:
    external: true
